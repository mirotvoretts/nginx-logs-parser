name: CI

on:
  push:
    branches: [ main, master, hw-3 ]
  pull_request:
    branches: [ main, master ]

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-Dmaven.repo.local=.m2/repository'

jobs:
  build:
    name: ğŸ”¨ Build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ğŸ”¨ Build with Maven
        run: mvn clean package shade:shade -DskipTests=true -Djacoco.skip=true

      - name: ğŸ“¦ Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/hw3-logs-1.0.jar
          retention-days: 7

  lint:
    name: ğŸ” Lint
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ğŸ¨ Spotless Check
        run: mvn spotless:check

      - name: ğŸ”¬ Modernizer Check
        run: mvn compile modernizer:modernizer

      - name: ğŸ› SpotBugs Check
        run: mvn compile spotbugs:check

      - name: ğŸ“‹ PMD Check
        run: mvn compile pmd:check pmd:cpd-check

  test:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ğŸ§ª Run tests with coverage
        run: mvn clean verify

      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: target/site/jacoco/jacoco.xml
          fail_ci_if_error: false
        continue-on-error: true

      - name: ğŸ“ˆ Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            target/surefire-reports/
            target/site/jacoco/
          retention-days: 7

  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: [ build, test ]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: ğŸ“¥ Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target/

      - name: ğŸ”— Run acceptance tests
        run: |
          chmod +x ./scripts/run_acceptance_tests.sh
          ./scripts/run_acceptance_tests.sh
